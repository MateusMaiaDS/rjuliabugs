---
title: "Plotting rjuliabugs draws using bayesplot package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Plotting rjuliabugs draws using bayesplot package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  fig.align='center', fig.width=4, fig.height=3, dpi=150,
  warning = FALSE,message = FALSE,
  comment = "#>"
)
```

## Overview

This article focuses on plotting parameter estimates from MCMC draws obtained using the `rjuliabugs::juliaBUGS()` sampler. We do not cover MCMC diagnostics or alternative visualization tools and packages, although these could be easily adapted, since all plots here operate on the `params` array extracted from the `rjuliabugs` object. The visualizations shown are based on those presented in the original vignette by Jonah Gabry and Martin Modrák. We strongly recommend reading their article: https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html. Much of the code and several of the plots here are directly inspired by their examples.

To begin, we load the necessary models to reproduce the examples:


```{r warning=FALSE,message=FALSE}
library(bayesplot)
library(ggplot2)
library(rjuliabugs)
```

## Example

As previously mentioned the goal of this vignette is exclusively to show how to use and present some of the visualizations tools from samples obtained from the sampler from `rjuliabugs`. Therefore we will assume that the `rjuliabugs` model object is already fitted and named as `rjuliabugs_fit``. For a full walkthrough until this moment, please refer to the article named [Get Started](https://mateusmaiads.github.io/rjuliabugs/articles/rjuliabugs.html) until the section where we generate the [posterior draws from the sampler](https://mateusmaiads.github.io/rjuliabugs/articles/rjuliabugs.html#inference-running-the-sampler)

### Inspect the `params` object.

The `rjuliabugs` is a `S3 object` which contains all the information and data used in the sampler. This includes, from the the the name of identify the model object in the `Julia` environment, the `mcmc` configuration parameters to the posterior draws named as `params` which by default is given by an 3D numeric array with respective dimensions being (iterations \times chains \times parameters). The choice of array as the default is due to its compatibility with most of other packages in `R` enviroment to work with posterior samplers. However, the converstion to other types to be comptabilite to other packages is possible through the functions `as_rvar`, `as_mcmc` and `as_draws` which can be called over the model object itself (`as_rvar(rjuliabugs)`) or the `rjuliabugs$params` object (`as_rvar(juliabugs$params`). See the [reference](https://mateusmaiads.github.io/rjuliabugs/reference/index.html#converting-posterior-sample-formats) section for a complete documentation of the examples. 

```{r echo = FALSE, message = FALSE, warning = FALSE,include=FALSE}
library(rjuliabugs)
set.seed(42)
data <- list(
    r = c(10, 23, 23, 26, 17, 5, 53, 55, 32, 46, 10, 8, 10, 8, 23, 0, 3, 22, 15, 32, 3),
    n = c(39, 62, 81, 51, 39, 6, 74, 72, 51, 79, 13, 16, 30, 28, 45, 4, 12, 41, 30, 51, 7),
    x1 = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
    x2 = c(0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1),
    N = 21
)
model_def <- "
model {
    for (i in 1:N) {
        r[i] ~ dbin(p[i], n[i])
        b[i] ~ dnorm(0.0, tau)
        logit(p[i]) <- alpha0 + alpha1 * x1[i] + alpha2 * x2[i] +
                       alpha12 * x1[i] * x2[i] + b[i]
    }
    alpha0 ~ dnorm(0.0, 1.0E-6)
    alpha1 ~ dnorm(0.0, 1.0E-6)
    alpha2 ~ dnorm(0.0, 1.0E-6)
    alpha12 ~ dnorm(0.0, 1.0E-6)
    tau ~ dgamma(0.001, 0.001)
    sigma <- 1 / sqrt(tau)
}
"

rjuliabugs_fit <- juliaBUGS(
  data = data,
  name = "rjuliabugs_fit",
  model_def = model_def,
  params_to_save = c("alpha0", "alpha1", "alpha2", "alpha12", "sigma"),
  n_iter = 2000,
  n_warmup = 1000,
  n_discard = 1000,
  n_chain = 4,
  use_parallel = TRUE,
  n_thin = 1
)

```

Verifying the dimensions of the `params` object we would have

```{r }
dim(rjuliabugs_fit$params)
```

we have a total of `r dim(rjuliabugs_fit$params)[1]` iterations, `r dim(rjuliabugs_fit$params)[2]` chains and `r dim(rjuliabugs_fit$params)[3]` parameters that were stored.

## Posterior uncertainty intervals

Central credible intervals from the posterior distribution can be visualized using the `mcmc_intervals` function.

### `mcmc_intervals`
```{r mcmc_intervals, fig.align='center'}
color_scheme_set("red")
mcmc_intervals(rjuliabugs_fit$params, pars =  rjuliabugs_fit$mcmc$params_to_save)

```

By default, the plot displays 50% credible intervals as bold lines and 90% intervals as thinner outer segments. These settings can be adjusted using the `prob` and `prob_outer` parameters, respectively. The plotted points represent the posterior medians; if preferred, the `point_est` option allows switching to posterior means or suppressing point estimates entirely.

To represent uncertainty with shaded regions beneath the posterior density estimates, the `mcmc_areas` function can be employed.

### `mcmc_intervals`

```{r mcmc_areas}
mcmc_areas(
  rjuliabugs_fit$params, 
  pars = rjuliabugs_fit$mcmc$params_to_save,
  prob = 0.8, # 80% intervals
  prob_outer = 0.99, # 99%
  point_est = "mean"
)
```

### `mcmc_areas_ridges`

We can also generate additional plots with by calling `mcmc_areas_ridges`

```{r mcmc_areas_ridges}
mcmc_areas_ridges(
  rjuliabugs_fit$params, 
  pars = rjuliabugs_fit$mcmc$params_to_save,
  prob = 0.8, # 80% intervals
  prob_outer = 0.99, # 99%
  point_est = "mean"
)
```
## Univariate marginal posterior distributions

The `bayesplot` package includes functions for visualizing marginal posterior distributions through histograms or kernel density estimates, either by merging all Markov chains or displaying them individually.

### `mcmc_hist`

The `mcmc_hist` function plots marginal posterior distributions (combining all chains):

```{mcmc_hist}
color_scheme_set("blue")
mcmc_hist(rjuliabugs_fit$params, pars = c("alpha0", "sigma"))
```

### `mcmc_hist_by_chain`

To visualize individual histograms for each of the four Markov chains, the `mcmc_hist_by_chain` function can be used; it generates separate facets for each chain within the plot.


```{mcmc_hist_chain}
color_scheme_set("darkgreen")
mcmc_hist_by_chain(rjuliabugs_fit$params, pars = c("alpha0", "sigma"))
```

If we are interested in also display a transformation for display any of the histograms, this is possible by setting the `transformations` argument.

```{mcmc_hist_chain_transform}
color_scheme_set("darkgreen")
mcmc_hist_by_chain(rjuliabugs_fit$params, pars = c("alpha0", "sigma"),
                   transformations = list("sigma" = "log"))
```


Many of the plotting functions for MCMC draws also include a `transformations` argument to apply transformations to the parameters before plotting.


### `mcmc_dens`

The `mcmc_dens` function works similarly to `mcmc_hist`, but it displays kernel density estimates in place of histograms. This include a version of `mcmc_dens_by_chain`.


```{r mcmc_dens}
color_scheme_set("brightblue")
mcmc_dens(rjuliabugs_fit$params, pars = c("alpha0", "sigma"))
```

### `mcmc_dens_overlay`

Similar to `mcmc_hist_by_chain`, the `mcmc_dens_overlay` function distinguishes between Markov chains; however, rather than showing them in separate panels, it overlays their density estimates in a single plot.

```{r mcmc_dens_overlay}
mcmc_dens_overlay(rjuliabugs_fit$params, pars = c("alpha0", "sigma"))
```


### `mcmc_violin`

The `mcmc_violin` function visualizes the density estimates for each chain using violin plots and adds horizontal lines at quantiles specified by the user.

```{r mcmc_violion}
color_scheme_set("teal")
mcmc_violin(rjuliabugs_fit$params, pars = c("alpha0", "alpha12"))
```


## Bivariate plots

A range of functions can be used to visualize bivariate marginal posterior distributions. Several of these functions allow optional parameters to incorporate MCMC diagnostic details into the plots. The extended diagnostic features are explained in a separate vignette focused on visual MCMC diagnostics. The examples here replicate some examples but for complete reference check the original [documentation](https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html)

### `mcmc_scatter`

The `mcmc_scatter` function generates a basic scatter plot showing the relationship between two parameters.


```{r mcmc_scatter}
color_scheme_set("orange")
mcmc_scatter(rjuliabugs_fit$params, 
             pars = c("alpha0", "alpha12"),
             size = 1.5,
             alpha = 0.5)
```


### `mcmc_hex`

The `mcmc_hex` function produces a comparable plot using hexagonal bins, which helps reduce overplotting when many points overlap.

```{r mcmc_hex}
color_scheme_set("gray")
# requires hexbin package
if (requireNamespace("hexbin", quietly = TRUE)) {
  mcmc_hex(rjuliabugs_fit$params, pars = c("alpha0", "alpha12"))
}
```

### `mcmc_pairs`

In addition to `mcmc_scatter` and `mcmc_hex`, the bayesplot package also includes the `mcmc_pairs` function, which allows users to create pairs plots for exploring relationships among multiple parameters.

```{r mcmc_pairs}
color_scheme_set("purple")
# requires hexbin package
mcmc_pairs(rjuliabugs_fit$params, 
         pars = c("alpha0", "alpha1","alpha12"),
         off_diag_args = list(size = 1.5))
```


Univariate marginal posterior distributions appear along the diagonal as histograms by default, but this can be switched to density plots using `diag_fun = "dens"`. The bivariate relationships are shown above and below the diagonal using scatter plots, though these can be replaced with hex-bin plots by setting `off_diag_fun = "hex"`. By default, `mcmc_pairs` splits the Markov chains—showing half above the diagonal and the rest below if the number of chains is even. Additional options for customizing how chains are divided across these plots are available through the `condition` argument, although these settings are primarily useful when including MCMC diagnostic information. Further details on that are provided in the official vignette from `bayesplot` documentation named  [Visual MCMC Diagnostics vignette](https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html).

## Trace plots

Trace plots display Markov chains smaples, allowing users to inspect how parameter values evolve over iterations. This section presents the standard trace plots available in the `bayesplot` package.

### `mcmc_trace`

The `mcmc_trace` function generates basic trace plots to visualize the sampling paths of parameters across iterations.

```{r mcmc_trace}
color_scheme_set("blue")
mcmc_trace(rjuliabugs_fit$params, pars = c("alpha0", "sigma"))
```

If the differences between chains are difficult to distinguish, a mixed color scheme can be used to improve clarity. For example:


```{r mcmc_multiple_trace_color}
color_scheme_set("mix-blue-red")
mcmc_trace(rjuliabugs_fit$params, pars = c("alpha0", "sigma"),
           facet_args = list(ncol = 1, strip.position = "left"))
```

The example above also demonstrates the `facet_args` argument, which allows you to pass options to `ggplot2`'s `facet_wrap`. Setting `ncol = 1` stacks the trace plots in a single column, and `strip.position = "left"` moves the facet labels to the y-axis rather than displaying them above each plot.


### `mcmc_trace_highlight`

The `mcmc_trace_highlight` function displays points instead of lines and lowers the opacity of all chains except one, which is emphasized using the `highlight` argument.

```{r mcmc_higlight_traceplot}
color_scheme_set("viridis")
mcmc_trace_highlight(rjuliabugs_fit$params, pars = c( "sigma"),
           highlight = 1)
```


While trace plots focus on how the Markov chains evolve over iterations, `mcmc_rank_hist()` examines how well the chains mix by comparing the distribution of their ranks. Ideally, the histogram should be roughly uniform, indicating good mixing across chains. See Vehtari et al. (2021) for more background.

```{r mcmc_rank} 
mcmc_rank_hist(rjuliabugs_fit$params, pars = c("sigma"))
```

Additionally, `mcmc_rank_ecdf()` plots the empirical cumulative distribution functions (ECDFs) of the ranks along with simultaneous confidence bands. These bands have a coverage probability controlled by the `prob` argument, meaning they are designed to fully contain all rank ECDFs with probability `prob`. When `plot_diff = TRUE`, the plot also shows the difference between the observed rank ECDFs and the theoretical uniform distribution expected if all samples came from the same distribution. For more details, see Säilynoja et al. (2022). The function arguments are similar to `mcmc_rank_hist`.

## References

Aki Vehtari, Andrew Gelman, Daniel Simpson, Bob Carpenter, Paul-Christian Bürkner "Rank-Normalization, Folding, and Localization: An Improved  R-hat for Assessing Convergence of MCMC (with Discussion)," Bayesian Analysis, Bayesian Anal. 16(2), 667-718, (June 2021)

Säilynoja, T., Bürkner, PC. & Vehtari, A. Graphical test for discrete uniformity and its applications in goodness-of-fit evaluation and multiple sample comparison. Stat Comput 32, 32 (2022). https://doi.org/10.1007/s11222-022-10090-6

Gabry, J., and Goodrich, B. (2017). rstanarm: Bayesian Applied Regression Modeling via Stan. R package version 2.15.3. https://mc-stan.org/rstanarm/, https://CRAN.R-project.org/package=rstanarm

Gabry, J., Simpson, D., Vehtari, A., Betancourt, M. and Gelman, A. (2019), Visualization in Bayesian workflow. J. R. Stat. Soc. A, 182: 389-402. :10.1111/rssa.12378. (journal version, arXiv preprint, code on GitHub)

Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., and Rubin, D. B. (2013). Bayesian Data Analysis. Chapman & Hall/CRC Press, London, third edition.

Stan Development Team. (2017). Stan Modeling Language Users Guide and Reference Manual. https://mc-stan.org/users/documentation/

Stan Development Team. (2024). bayesplot: Plotting for MCMC draws. https://mc-stan.org/bayesplot/articles/plotting-mcmc-draws.html
